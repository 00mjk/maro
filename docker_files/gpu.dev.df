FROM nvidia/cuda:10.0-base-ubuntu16.04

# NOTE: this docker based CUDA 10.0 version, please set up your machine first
# NOTE: to use cuda in docker, you need to specified --runtime=nvidia to run

WORKDIR /maro_dev

COPY ./requirements.dev.txt /maro_dev/requirements.dev.txt

# cuda libs and missing tools
RUN apt-get update && apt-get install -y --no-install-recommends \
        apt-utils \
        build-essential \
        cuda-command-line-tools-9-0 \
        cuda-cublas-9-0 \
        cuda-cufft-9-0 \
        cuda-curand-9-0 \
        cuda-cusolver-9-0 \
        cuda-cusparse-9-0 \
        libcudnn7=7.2.1.38-1+cuda9.0 \
        libcudnn7-dev=7.2.1.38-1+cuda9.0 \
        libnccl2=2.2.13-1+cuda9.0 \
        libnccl-dev=2.2.13-1+cuda9.0 \
        curl \
        && \
    rm -rf /var/lib/apt/lists/*

# Install miniconda to /miniconda
RUN curl -LO http://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
RUN bash Miniconda3-latest-Linux-x86_64.sh -p /miniconda -b
RUN rm Miniconda3-latest-Linux-x86_64.sh
ENV PATH=/miniconda/bin:${PATH}
RUN conda update -y conda

RUN pip install --no-cache-dir -r requirements.dev.txt

ENV PYTHONPATH "/maro_dev:${PYTHONPATH}"

# build
CMD ["sh"]